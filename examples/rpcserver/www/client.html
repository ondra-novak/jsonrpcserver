<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<style>
.curses {
	float:right;
	width: 500px;
	border: 1px solid;
	padding: 5px;
	background-color: #EED;
}
body {
	background-color:#DDD;
}

.loginBox {
	display:none;
	width: 17em; 
	position: absolute; 
	right:100px;
	top:100px;
	border: 1px solid;
	background-color:#CCC;
	padding:10px;
	text-align:right;
}
.extendBox {
	display:none;width: 17em; 
	position: absolute; 
	right:100px; 
	top:100px;
	border: 1px solid;
	background-color:#CCC;
	padding:10px;
	text-align:right;
}
.extendBox input{
  width: 50px;
}
.openSesBox {
	display:none;
	width: 30em; 
	position: absolute; 
	right:100px;
	 top:100px;
	 border: 1px solid;
	 padding:10px;
	text-align:right;
	background-color:#CCC;
	}
	
.inputBox {
	width:600px;
	float:left;
}
.inputBox .helpButton {
	width: 20px;
	float:right;
}
.inputBox textArea{
width:100%;
margin-left:-3px;
}
.resultBox {
	border-top: 1px dotted;
	clear: both;
	margin-top: 20px;
}


table.jsontable, table.jsonlist {
    border: 1px solid #AAA;
    border-spacing: 0px 0px;
    border-collapse:collapse;
}
th {
    vertical-align:top;
    text-align:center;
    padding: 0px 10px 0px 10px;
    border: 1px solid #CCC;
    background-color: #EDD;

}


th.lfc {
    text-align:right;
    background-color: #DDC;
    border: 1px solid #888;
}

table.jsontable td {
    text-align:center;
    border: 1px solid #CCC;
    vertical-align: top;
}

table.jsonlist td {
    text-align:left;
    border: 1px solid #CCC;
    vertical-align: top;
}

    .jsoncontent {
        padding: 0 5px 0 5px;
    }

tr:nth-child(even) {background: #EEE}
tr:nth-child(odd) {background: #FFF}

</style>
</head>

<body>

	<div class="curses">
	<div>Current session: <span id="cursession">(none)</span></div>
	<div><span id="cursessionuser"></span></div>
	<div>
	<input value="open session" onclick="doOpenSession()" id="opensessionbutt" type="button">
	<input value="logout" onclick="doLogout()" id="logoutbutt" style="display:none" type="button">	
	</div>	
	</div>	
	</div>
	<form class="inputBox">
	Method: <input name="method" id="method" type="text">
	<input value="..." onclick="methodChoose()" type="button">
	<input value="&lt;" onclick="getFromHistoryPrev()" type="button">
	<input value="&gt;" onclick="getFromHistoryNext()" type="button">
	<div id="hiddenList" class="hiddenList" style="display:none;position:relative">
	<div style="position:absolute;width:300px;left: 10em;">
	<select size="16" onchange="setMethodName(this)" id="methodList" style="min-width: 300px;"></select>
	</div>
	</div>	
	<div>JSON arguments: <br>
	<textarea rows="5" cols="80" name="data" id="data">[]</textarea><br>	
	<input class="helpButton" value="?" onclick="helpOnMethod()" type="button">
	<input value="odeslat" onclick="sendRequest()" type="button">
    <label><input type="checkbox" id="rawresult" /> Raw JSON</label>
	</div>
	</form>
	<div class="resultBox">
	<h2>Result:</h2>
	<div class="error" id="error"></div>
	<div class="result" id="result"></div>
	</div>
	<div class="loginBox" id="loginBox">
	<form>
	Username: <input name="username" id="username" type="text"><br>
	Password: <input name="password" id="password" type="password"><br>
	<input value="Login" onclick="doLoginSubmit();" type="button">
	<input value="Cancel" onclick="doLoginCancel();" type="button">
	</form>
	</div>
	<div class="extendBox" id="extendBox">
	<form>
	Time (minutes): <input name="time" id="time" type="text" value="15"><br>
	User level: <select name="level" id="level">
	<option value="">-- select to change ---</option>
	<option>system</option>
	<option>admin</option>
	<option>manager</option>
	<option>user</option>
	<option>limited</option>
	</select><br>
	<input value="Extend" onclick="doExtendSubmit();" type="button">
	<input value="Cancel" onclick="doExtendCancel();" type="button">
	</form>
	</div>
	<div class="openSesBox" id="openSesBox" style="">
	<form>
	SessionId: <input name="entersessionid" id="entersessionid" type="text" value="" style="width:30em"><br>
	<input value="Open" onclick="doOpenSessionSubmit();" type="button">
	<input value="Cancel" onclick="doOpenSessionCancel()" type="button">
	</form>
	</div>
	


<script type="text/javascript">
//Gets the browser specific XmlHttpRequest Object
function getXmlHttpRequestObject() 
{
	if (window.XMLHttpRequest) {
		return new XMLHttpRequest(); //Not IE	
	}else if(window.ActiveXObject) {
		return new ActiveXObject("Microsoft.XMLHTTP"); //IE	
	} else {
		alert("Your browser doesn't support the XmlHttpRequest object.  Better upgrade to Firefox.");	
	}
}

var idcounter=1;
var wget = getXmlHttpRequestObject();
var methodwget = getXmlHttpRequestObject();
var historie = new Array();
var cursession = null;


    //1 - inline - item is such small that can be put as one element
    //2 - item can be whole put at single line (or table cell)
    //3 
    //3 - complex item - takes more lines
var ITEM_INLINE = 1;
var ITEM_CELLTABLE = 2;
var ITEM_LINE = 2;
var ITEM_MULTILINE = 3;

function getItemComplexLevel(item) {
    if (item == null) return ITEM_INLINE;
    if (typeof (item) == "number") return ITEM_INLINE;
    if (typeof (item) == "string") return item.length > 30 ? ITEM_CELLTABLE : ITEM_INLINE;
    if (typeof (item) == "boolean") return ITEM_INLINE;
 /*   if (item instanceof Array) {
        var maxcomplex = ITEM_INLINE;
        for (var i = 0; i < item.length; i++) {
            var c = item[i];
            var complex = getItemComplexLevel(c);
            if (complex > maxcomplex) maxcomplex = complex;
        }
        if (maxcomplex < ITEM_MULTILINE && item.length > 4) maxcomplex++;
        return maxcomplex;
    }*/
    return ITEM_MULTILINE;
}

function getTableColumns(item) {
    if (typeof (item) != "object") return null;
        var columns = [];
        var tc = 0;
        for (var i in item) {
            var localcol = [];
            var totalLen = 0;
            if (typeof(item[i]) != "object") return null;
            for (var j in item[i]) {
                var x = item[i][j];
                var c = getItemComplexLevel(x);
                if (c < ITEM_MULTILINE) {
                    totalLen += JSON.stringify(x).length;
                    if (totalLen > 200) return null;
                }
                localcol.push(j);
            }

            tc += localcol.length;
            for (var j = 0; j < localcol.length; j++) {
                if (columns.indexOf(localcol[j]) == -1) columns.push(localcol[j]);

            }
        }
        if ( columns.length > 12) return null;
        else return columns;
}
function formatRawResultToDOM(item, element) {
    var e = document.createElement("pre");
    e.appendChild(document.createTextNode(JSON.stringify(item, null, "    ")));
    element.appendChild(e);
}


function formatResultToDOM(item, element) {
    if (item != null && typeof (item) == "object") {
        var columns = getTableColumns(item);
         if (columns != null) {
                var t = document.createElement("table");
                t.className = "jsontable";
                element.appendChild(t);
                var r = document.createElement("tr");
                var h = document.createElement("th");
                r.appendChild(h);
                h.className = "blind";
                for (var i = 0; i < columns.length; i++) {
                    var h = document.createElement("th");
                    h.appendChild(document.createTextNode(columns[i]));
                    r.appendChild(h);
                    t.appendChild(r);
                }
                for (var i in  item) {
                    r = document.createElement("tr");
                    t.appendChild(r);
                    var h = document.createElement("th");
                    h.className = "lfc";
                    r.appendChild(h);
                    h.appendChild(document.createTextNode(i));
                    var v = item[i];
                    for (var j = 0; j < columns.length; j++) {
                        var c = columns[j];
                        var d = document.createElement("td");
                        r.appendChild(d);
                        if (v.hasOwnProperty(c)) formatResultToDOM(v[c], d);
                    }
                }
        } else {
            var t = document.createElement("table");
            t.className="jsonlist";
            for (var i in item) {
                var r = document.createElement("tr");
                var h = document.createElement("th");
                var d = document.createElement("td");
                h.className = "lfc";
                t.appendChild(r);
                r.appendChild(h);
                r.appendChild(d);
                var value = item[i];
                h.appendChild(document.createTextNode(i));
                if (getItemComplexLevel(value) < ITEM_MULTILINE) {
                    var ct = document.createElement("div");
                    ct.className = "jsoncontent";
                    d.appendChild(ct);
                    ct.appendChild(document.createTextNode(JSON.stringify(value)));
                } else {
                    formatResultToDOM(value, d);
                }
            }
            element.appendChild(t);
        }
    } else {
        var ct = document.createElement("div");
        ct.className = "jsoncontent";
        element.appendChild(ct);
        ct.appendChild(document.createTextNode(JSON.stringify(item)));
    }
    
}


function storeToHistory(method,data) {
		if (historie.length > 0)
		{
			if (historie[0].method == method &&
					historie[0].data == data) return;

			var rec = historie.pop();
			historie.push(rec);
			if (rec.method == method && rec.data == data) return;
		}
		historie.push({"method":method,"data":data});
		if (historie.length > 1000) historie.shift();
}

function getFromHistoryPrev() {
		if (historie.length > 0) {
			var rec = historie.pop();
			historie.splice(0,0,rec);
			rec = historie.pop();
			document.getElementById("method").value = rec.method;
			document.getElementById("data").value = rec.data;
			historie.push(rec);
		}
}


function getFromHistoryNext() {
	if (historie.length > 0) {
			var rec = historie[0];
			document.getElementById("method").value = rec.method;
			document.getElementById("data").value = rec.data;
			historie.shift();
			historie.push(rec);
	}
}

function doJSONRPCRequest(method,data,callback) {
	var session = cursession == null? "":", \"context\":{\"session\":\""+cursession+"\"}";
	var id=idcounter; 
	var body="{\"method\":\""+method+"\",\"params\":" + data + ",\"id\":\"" + id + "\"" + session + "}";
	idcounter++;
	wget.abort();
	wget.open("POST",location.href);
	wget.setRequestHeader("Content-Type","application/json");
	wget.send(body);
	wget.onreadystatechange=function()
	{	
		if (wget.readyState==4) {
			if (wget.status != 200) {
				 callback(null,"Http request failed. Code: "+wget.status);
			} else {	
				var res = wget.responseText;
				var objres;
				var error;
				try {
					eval("objres = "+res);
					if (objres.error != null) error = objres.error; 
				} catch (e) {
					error = res;
				}
				if (error != null) callback(null,error);
				else callback(objres.result,null);
			}
		}
	}
}

function sendRequest() {

	var method = document.getElementById("method").value;
	var data = document.getElementById("data").value;
	
	storeToHistory(method,data);

	document.getElementById("error").innerHTML = "";
	document.getElementById("result").innerHTML = "...please wait...";

	doJSONRPCRequest(method, data, function (res, error) {

	    var errelem = document.getElementById("error");
	    var resultelem = document.getElementById("result");
	    var rawchk = document.getElementById("rawresult");
	    var raw = rawchk.checked;

	    if (errelem.firstChild) errelem.removeChild(errelem.firstChild);
	    if (resultelem.firstChild) resultelem.removeChild(resultelem.firstChild);

	    if (raw) {
	        if (error != null) {
	            formatRawResultToDOM(error, errelem);
	        } else {
	            formatRawResultToDOM(res, resultelem);
	        }
	    } else {

	        if (error != null) {
	            formatResultToDOM(error, errelem);
	        } else {
	            formatResultToDOM(res, resultelem);
	        }
	    }

	});
}

function methodChoose() {
	var list = document.getElementById("methodList");
	var listcont = document.getElementById("hiddenList"); 
	if (listcont.style.display == "block") {
		listcont.style.display = "none";
		return; 
	} else {
		listcont.style.display = "block";
	}

	doJSONRPCRequest("Server.listMethods", "[]", function(res,error) {
		if (res != null) {
			var cursel = list.selectedIndex; 
			var llen = list.length;
			for (i = 0; i < llen; i++) {
				list.remove(0);
			}
			llen = res.length;
			for (i = 0; i < llen; i++) {
				list.add(new Option(res[i],res[i]),null);
			}
			list.selectedIndex = cursel;
		}
	});
	
}


function setMethodName(sel) {
	var item = sel.selectedIndex;
	var val = sel.options[item].value;
	var sep = val.indexOf(' ');
	var args = "[]";
	if (sep != -1) {
		args = val.substr(sep+1);
		val = val.substr(0,sep);
	} 
	document.getElementById("method").value = val;
	document.getElementById("data").value = args;
	var listcont = document.getElementById("hiddenList"); 
	listcont.style.display = "none";	
}

function doLogin() {
	document.getElementById("loginBox").style.display="block";	
	document.getElementById("username").focus();
}

function doExtend() {
	document.getElementById("extendBox").style.display="block";	
	document.getElementById("time").focus();
}

function doOpenSession() {
	document.getElementById("openSesBox").style.display="block";	
	document.getElementById("entersessionid").focus();
}

function updateSessionInfo() {
	if (cursession != null) {
		document.getElementById("opensessionbutt").style.display="none";
		document.getElementById("logoutbutt").style.display="inline";
		document.getElementById("cursession").innerHTML = cursession;
	} else {
		document.getElementById("logoutbutt").style.display="none";
		document.getElementById("opensessionbutt").style.display="inline";
		document.getElementById("cursession").innerHTML = "(none)";
	}		

}

function doLogout() {
	cursession = null;
	updateSessionInfo();
}

function doLoginCancel() {
	document.getElementById("loginBox").style.display="none";	
}

function doExtendCancel() {
	document.getElementById("extendBox").style.display="none";	
}

function doOpenSessionCancel() {
	document.getElementById("openSesBox").style.display="none";	
}



function stripHTML(html)
{
   var tmp = document.createElement("DIV");
   tmp.innerHTML = html;
   return tmp.textContent||tmp.innerText;
}


function doLoginSubmit() {
	var username = document.getElementById("username").value;
	var password = document.getElementById("password").value;

	doJSONRPCRequest("Session.create", "[\""+username+"\",\""+password+"\"]", function(res,error) {
		if (error != null) {
			alert(stripHTML(print_r(error)));
		} else {
			cursession=res;
			document.getElementById("loginBox").style.display="none";
			updateSessionInfo();
		}
	});
			
}

function doExtendSubmit() {
	var time = document.getElementById("time").value;
	var level = document.getElementById("level").value;

	doJSONRPCRequest("Session.extend", "["+time
			+(level!=""?(",\""+level+"\""):"")
			+"]", function(res,error) {
		if (error != null) {
			alert(stripHTML(print_r(error)));
		} else {
			cursession=res;
			updateSessionInfo();
			document.getElementById("extendBox").style.display="none";
		}
	});
			
}

function doOpenSessionSubmit() {
	var ses = document.getElementById("entersessionid").value;
	cursession=ses;
	updateSessionInfo();
	document.getElementById("openSesBox").style.display="none";			
}

function helpOnMethod() {
	var method = document.getElementById("method").value;

	document.getElementById("error").innerHTML = "";
	document.getElementById("result").innerHTML = "...please wait...";

	doJSONRPCRequest("Server.help", "[\""+method+"\"]", function(res,error) {
		document.getElementById("error").innerHTML = error == null?"":JSON.stringify(error,null," ");
		document.getElementById("result").innerHTML = res == null ? "" : res;
	});

}

</script>



</body></html>